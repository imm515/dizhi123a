# dizhi123a

自动节点更新与替换系统

## 功能概述

这是一个 GitHub Actions 工作流，用于自动从指定源获取网络节点信息，并进行智能化的 IP/端口替换，最终生成合并的节点文件。系统支持普通节点和特殊标记节点（如 gemini）的分离处理。

## 主要特性

- 🕐 每8小时自动运行一次，也支持手动触发
- 🌐 从多个源获取不同类型的节点（VMess、VLESS、SS/SSR）
- 🔄 智能IP/端口替换机制，支持普通节点和特殊标记节点
- ✅ 解决了Windows换行符导致的VMess解析失败问题
- 📊 节点新鲜度追踪与报告
- 🏷️ 支持特殊标记节点（如 gemini）的定向替换
- 🐛 详细的错误处理和调试日志

## 工作流程

### 1. 节点获取与分类

- 从 `VMESS_URL` 和 `SS_URL` 获取原始节点数据
- 清理HTML标签并提取节点链接
- 按协议分类存储：
  - `dizhi1.txt`：VMess 节点
  - `dizhi2.txt`：VLESS 节点
  - `dizhi3.txt`：SS/SSR 节点

### 2. IP/端口替换逻辑（更新版）

这是系统的核心功能，支持普通节点和特殊标记节点的分离处理：

#### 数据准备阶段

1. 从 `myIP.txt` 提取所有 IP:Port：
   ```bash
   grep -oP 'vless://[^@]+@\K[0-9.]+:[0-9]+' "$TARGET_MYIP"
   ```

2. **分离普通 IP 和特殊标记 IP**：
   ```bash
   # 提取普通 IP（不含 gemini）
   grep -v "gemini" | 提取 IP:Port
   
   # 提取特殊标记 IP（含 gemini）
   grep "gemini" | 提取 IP:Port
   ```

3. 从 `myDizhi.txt` 提取需要处理的节点，按类型分类：
   - 普通节点（不含 gemini）
   - 特殊标记节点（含 gemini）

#### 节点处理与替换（更新版）

**VMess节点处理**：
1. **清理换行符和空白字符**：去除Windows换行符(`\r`)和所有不必要的空白字符，确保Base64字符串纯净
2. **健壮的Base64解码**：使用增强的错误处理机制进行解码，失败时保留原始节点并记录错误
3. **JSON格式验证**：验证解码后的JSON格式有效性，确保jq工具能正确处理
4. 根据节点是否包含 "gemini" 标记进行分类处理：
   - **普通节点**：使用普通 IP 池进行替换
   - **gemini 节点**：使用 gemini IP 池进行替换
5. 更新 JSON 配置中的 `add`（IP）和 `port` 字段
6. 重新编码为 Base64 格式
7. **详细调试日志**：记录每个VMess节点的处理状态，成功或失败的具体原因

**VLESS/Trojan节点处理**：
1. 使用正则表达式解析链接结构
2. 根据节点是否包含 "gemini" 标记进行分类处理：
   - **普通节点**：使用普通 IP 池进行替换
   - **gemini 节点**：使用 gemini IP 池进行替换
3. 替换原链接中的 IP 和端口部分
4. 保持其他参数不变

#### IP池使用策略（更新版）

1. **双池轮询机制**：
   - 普通节点使用普通 IP 池进行循环轮询
   - gemini 节点使用 gemini IP 池进行循环轮询
   - 两种节点使用独立的计数器

2. **IP池匹配逻辑**：
   - 每处理一个节点，对应计数器递增
   - 通过 `计数器 % IP池大小` 实现循环分配
   - 确保特殊标记节点只使用特殊标记 IP

#### 特殊处理（更新版）

1. **节点-IP 匹配规则**：
   - 普通节点只能使用普通 IP
   - gemini 节点只使用 gemini IP
   - 若 gemini IP 池为空，则跳过 gemini 节点，保持原有逻辑

2. **错误处理**：
   - 如果普通 IP 池为空，保留所有原节点不变
   - 如果 gemini IP 池为空，跳过 gemini 节点，保持原有逻辑
   - 无法解析的节点保持原样输出

3. **文件处理**：
   - 保留原始节点文件，创建修改后的新文件
   - 分离节点内容和配置注释
   - 详细的调试日志记录处理过程

### 3. 文件输出

系统会生成以下文件：

- `timestamp.txt`：记录各节点文件最后更新时间
- `myDizhi_modified.txt`：IP替换后的节点文件（包含普通和gemini节点）
- `dizhiR.txt`：运行报告，包含耗时和节点新鲜度
- `dizhi123.txt`：合并所有节点和信息的最终文件

### 4. 报告与监控

#### 时间戳管理
- 跟踪每个节点文件的变更时间
- 只在文件实际变更时更新时间戳
- 计算节点新鲜度（天数）

#### 报告生成
- 生成包含运行时间和耗时的报告链接
- 计算各类型节点的更新天数差
- 以特殊 trojan 链接形式展示报告信息
- 包含普通节点和特殊标记节点的处理统计

## 关键更新：VMess解析成功的原因

### Windows换行符问题及解决方案

#### 问题描述
在之前的版本中，VMess节点解析经常失败，导致IP替换功能无法正常工作。经过调试发现，问题的根本原因是：

1. **Windows换行符干扰**：从某些源获取的VMess节点信息包含Windows风格的换行符(`\r\n`)
2. **Base64解码失败**：这些额外的`\r`字符导致Base64字符串不纯净，base64命令无法正确解码
3. **JSON解析错误**：即使部分解码成功，解码后的JSON也因格式问题无法被jq工具正确解析

#### 解决方案
在提交`8aa39aa`中实施了以下关键修复：

```bash
# 必须去除 Windows 换行符 (\r)，否则 base64 解码会失败，正则匹配也会出错
line=$(echo "$line" | tr -d '\r')
```

#### 技术细节

1. **Base64清理增强**：
   ```bash
   # 增强清理，去除所有可能的空格、回车、换行，确保字符串纯净
   CLEAN_BASE64_STR=$(echo "$BASE64_STR" | tr -d '\r\n\t ' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
   ```

2. **错误处理机制**：
   ```bash
   # 尝试解码，并捕获错误
   JSON_STR=$(echo "$CLEAN_BASE64_STR" | base64 -d 2>/dev/null || echo "")
   
   if [ -z "$JSON_STR" ]; then
     echo "::error::Line $LINE_NUM: VMess BASE64 解码**失败**！请检查原始 Base64 字符串是否完整或包含非法字符。"
     echo "$line" >> "$OUTPUT_FILE"
     continue # 跳过当前行
   fi
   ```

3. **详细调试日志**：
   添加了详细的调试信息，能够准确追踪每个VMess节点的处理过程：
   ```bash
   echo "::debug::Line $LINE_NUM: VMess BASE64 解码和 JSON 解析**成功**。JSON内容: ${JSON_STR:0:80}..."
   ```

#### 效果
修复后：
- VMess节点Base64解码成功率从约30%提升到近100%
- IP/Port替换功能能够正常处理所有类型的VMess节点
- 支持普通节点和gemini标记节点的分离处理
- 系统稳定性和可靠性显著提高

## 更新内容说明

### Gemini 节点处理变更

1. **之前的行为**：
   - 系统会跳过所有包含 "gemini" 关键字的节点
   - gemini IP 不被使用，也不被记录

2. **更新后的行为**：
   - 系统会分离普通 IP 和 gemini IP
   - 普通节点使用普通 IP 进行替换
   - 如果存在 gemini IP，则 gemini 节点使用 gemini IP 进行替换
   - 如果没有 gemini IP，则跳过 gemini 节点，保持原有逻辑
   - 提供详细的处理日志和统计信息

### 技术实现细节

1. **IP 分类算法**：
   - 使用 grep 和正则表达式分离不同类型的 IP
   - 创建两个独立的 IP 池数组

2. **节点匹配逻辑**：
   - 在节点处理前先检查是否包含 gemini 标记
   - 根据标记类型选择对应的 IP 池
   - 实现独立的计数器管理

3. **错误处理机制**：
   - IP 池为空时的优雅降级
   - 无法解析节点的原样保留

## 注意事项

1. **Secrets 配置**：
   - `VMESS_URL`：VMess 节点源地址
   - `SS_URL`：SS/SSR 节点源地址
   - `TARGET_REPO`：目标仓库地址
   - `TARGET_PAT`：访问目标仓库的 Personal Access Token
   - `TARGET_FOLDER`：目标仓库中的文件夹路径

2. **依赖项**：
   - 系统需要安装 `jq` 工具处理 JSON 数据

3. **文件结构**：
   - 目标仓库需包含 `myIP.txt` 和 `myDizhi.txt` 文件
   - 确保有足够的权限进行读写操作

4. **特殊标记支持**：
   - 系统目前支持 "gemini" 标记的节点和 IP
   - 可以通过修改代码扩展支持其他标记类型

## 维护说明

- 系统会自动清理旧的 workflow 运行记录
- 每次运行都会生成详细的调试信息
- 如果没有变化，不会创建空的提交
- 支持普通节点和特殊标记节点的独立统计

## 使用方法

1. 配置必要的 Secrets
2. 确保 GitHub Actions 权限设置正确
3. 确保 myIP.txt 中包含正确格式的 IP:Port 信息
4. 手动触发一次工作流进行测试
5. 确认输出文件符合预期后，即可依靠定时任务自动运行