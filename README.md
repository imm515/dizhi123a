# 项目自动化流程（GitHub Actions）说明

本项目利用自动化流程管理三个核心任务，旨在确保数据的时效性、生成以及关键数据列表的维护。

## ⚙️ 流程总览

| 文件名 | 流程名称 | 触发方式 | 核心功能 | 
| ----- | ----- | ----- | ----- | 
| 流程 2 | **数据采集与开始记录** | 定期排程 (每 8 小时 35 分) + 手动触发 | 从外部来源获取节点信息并记录开始时间，作为工作链起点。 | 
| 流程 4 | **IPv6数据获取** | 自动触发 (流程2完成后) + 手动触发 | 使用Selenium抓取IPv6地址并更新myIPv6.txt文件。 | 
| 流程 5 | **节点生成与报告汇总** | 自动触发 (流程4完成后) + 手动触发 | 生成IPv6节点，记录结束时间，生成报告节点，并汇总所有数据到dizhi123.txt。 |

## 🚀 详细流程分析

### 工作链概述

本项目采用链式工作流设计，三个流程按顺序自动执行，形成完整的数据处理链条：
1. **流程2** 开始并采集基础数据
2. **流程4** 自动接续，处理IPv6数据
3. **流程5** 完成节点生成和报告汇总

### 1. 数据采集与开始记录 (流程2)

该流程负责从外部源获取节点数据，并记录整个工作链的开始时间。

**触发方式：**
* **自动排程：** 每8小时35分自动运行
* **手动触发：** 支持按需启动

**主要步骤：**
1. 记录工作链开始时间
2. 从外部URL获取VMESS、VLESS和SS节点信息
3. 清理和格式化节点数据
4. 处理myDizhi.txt文件，进行IP替换
5. 保存开始时间到workflow_start_time.txt文件，供流程5使用
6. 提交基础数据到目标仓库

### 2. IPv6数据获取 (流程4)

该流程负责抓取最新的IPv6地址，为节点生成做准备。

**触发方式：**
* **自动触发：** 流程2完成后自动执行
* **手动触发：** 支持按需启动

**主要步骤：**
1. 使用Selenium自动化工具从预设源抓取IPv6地址
2. 按来源对IPv6地址进行分组和管理
3. 更新myIPv6.txt文件，包含时间戳和来源信息
4. 提交IPv6数据到目标仓库

### 3. 节点生成与报告汇总 (流程5)

这是工作链的最后一步，负责生成IPv6节点、记录结束时间、生成报告节点，并汇总所有数据。

**触发方式：**
* **自动触发：** 流程4完成后自动执行
* **手动触发：** 支持按需启动

**主要步骤：**
1. 读取流程2保存的开始时间
2. 基于myIPv6.txt生成IPv6 VLESS节点
3. 记录工作链结束时间并计算总耗时
4. 生成包含统计信息的trojan报告节点
5. 汇总所有数据（dizhi1-3.txt、myDizhi.txt、IPv6节点、报告节点）到dizhi123.txt
6. 提交完整结果到目标仓库

### 🔗 工作链数据流

```
流程2 (开始时间) → 流程4 (IPv6数据) → 流程5 (结束时间+报告) → dizhi123.txt
```

这种设计确保了：
- 完整的工作时间统计（从流程2开始到流程5结束）
- 数据的连续性和一致性
- 自动化的端到端处理流程
- 集中的数据汇总和报告生成

### 📅 时间戳文件说明

项目中使用两个关键的时间戳文件来追踪和管理自动化流程：

#### 1. workflow_start_time.txt
- **作用**：记录整个工作链的开始时间，用于计算完整流程耗时
- **格式**：纯文本文件，包含单一时间戳（格式：YYYY-MM-DD HH:MM:SS）
- **生成**：由工作流2在开始采集数据时创建
- **位置**：目标仓库的指定目录中
- **使用**：被工作流5读取，与结束时间比较生成报告中的"耗时"信息

#### 2. timestamp.txt
- **作用**：追踪各个数据文件（dizhi1.txt、dizhi2.txt、dizhi3.txt）的最后更新时间
- **格式**：键值对形式，每行一个文件名及其时间戳
  ```
  dizhi1.txt:2024-12-11 14:35:00
  dizhi2.txt:2024-12-11 14:35:00
  dizhi3.txt:2024-12-11 14:35:00
  ```
- **生成逻辑**：只有当文件内容发生变化时才更新对应的时间戳
- **用途**：
  - 判断数据文件是否有更新
  - 计算各数据文件的"年龄"（天数）
  - 在报告中显示各类型节点的更新频率

### 📊 报告生成机制

基于这两个时间戳文件，系统生成包含以下信息的报告：
1. **流程耗时**：从workflow_start_time.txt读取开始时间，与当前时间计算得出
2. **节点年龄**：从timestamp.txt读取各文件更新时间，计算距离当前的天数
3. **报告节点**：以trojan节点形式展示在dizhi123.txt中，便于监控和统计

## 📁 系统文件结构

### 核心数据文件
- `dizhi1.txt` - 存储VMESS类型节点
- `dizhi2.txt` - 存储VLESS类型节点
- `dizhi3.txt` - 存储SS/SSR类型节点
- `dizhi123.txt` - 汇总所有节点的最终输出文件

### 处理过程中的临时文件
- `myDizhi_modified.txt` - 经过IP替换处理后的myDizhi.txt
- `myDizhi_ipv6_modified.txt` - 基于IPv6生成的VLESS节点
- `dizhiR.txt` - 包含统计信息的报告节点

### 时间戳和监控文件
- `workflow_start_time.txt` - 工作链开始时间
- `timestamp.txt` - 各数据文件更新时间戳
- `myIPv6.txt` - IPv6地址池（按来源分组）

### 源数据和配置
- `myDizhi.txt` - 原始节点模板文件
- `myIP.txt` - IP地址池
- `webpage_content.txt` - 从URL获取的网页内容
- `ss_webpage_content.txt` - SS源网页内容

## 🔒 依赖与配置

### 敏感配置信息 (Secrets)

以下敏感配置信息必须在GitHub仓库的Secrets中设置：

* `VMESS_URL`：用于获取VMESS节点内容的地址。

* `SS_URL`：用于获取SS节点内容的地址。

* `IPV6_SOURCE_URLS`：包含要抓取的IPv6列表URL，每行一个。

* `TARGET_REPO`：目标仓库的owner/repo格式，如'user/repo'。

* `TARGET_PAT`：具有对目标仓库写权限的Personal Access Token。

* `TARGET_FOLDER`：目标仓库中存放文件的路径，如'ipv6_lists'。

### 工作流配置变量

* **流程2**：
  * 定时任务：每8小时35分执行一次（可通过cron表达式修改）
  * 时区：Asia/Shanghai（北京时间）

* **流程4**：
  * `MAX_IPV6_COUNT`：聚合文件myIPv6.txt中保留的最大IPv6条数（默认500）

* **流程5**：
  * `VLESS_COUNT`：每个IPv6分组生成的VLESS节点数量（默认6）