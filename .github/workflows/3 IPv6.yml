# æ–‡ä»¶å: 3 IPv6.yml
name: 3 IPv6 Source Fetcher 

on:
  workflow_dispatch:

jobs:
  fetch_and_sync_ipv6:
    runs-on: ubuntu-latest
      
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Set Git Credentials
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
      - name: ğŸŒ Fetch IPv6 Addresses and Save Separately
        id: fetch
        # è¯»å– Secret å˜é‡
        env:
          URL_LIST: ${{ secrets.IPV6_SOURCE_URLS }}
          TARGET_DIR: ./ipv6_fetch_temp
          
        run: |
          echo "Start fetching and saving IPv6 sources..."
          
          mkdir -p $TARGET_DIR
          # *** å…³é”®ä¿®å¤ 1/2ï¼šåˆ›å»ºæœ€ç»ˆçš„æäº¤ä¿¡æ¯æ–‡ä»¶åœ¨å·¥ä½œåŒºæ ¹ç›®å½• ***
          COMMIT_DETAILS_BODY_FILE="commit_details_body.txt"
          COMMIT_MESSAGE_FILE="final_commit_message.txt" # æœ€ç»ˆæäº¤ä¿¡æ¯æ–‡ä»¶
          
          # ç¡®ä¿æ–‡ä»¶æ˜¯ç©ºçš„
          > "$COMMIT_DETAILS_BODY_FILE"
          
          if [ -z "$URL_LIST" ]; then
            echo "WARNING: IPV6_SOURCE_URLS is empty. Skipping fetch operation."
            echo "files_created=0" >> $GITHUB_OUTPUT 
            # å³ä½¿è·³è¿‡ï¼Œä¹Ÿéœ€è¦åˆ›å»ºç©ºçš„æäº¤ä¿¡æ¯æ–‡ä»¶ä»¥ä¾›ä¸‹ä¸€æ­¥ä½¿ç”¨
            echo "Skipped due to empty URL list." > "$COMMIT_MESSAGE_FILE"
            exit 0
          fi
          
          # ä½¿ç”¨ mapfile å®‰å…¨è¯»å–å¤šè¡Œ Secret
          URL_LIST_CLEANED=$(echo "$URL_LIST" | tr -d '\r')
          mapfile -t URLs <<< "$URL_LIST_CLEANED" 
          
          COUNT=0
          
          for URL in "${URLs[@]}"; do
            URL=$(echo "$URL" | tr -d '[:space:]')
            if [ -z "$URL" ]; then
                continue
            fi
            
            HOSTNAME=$(echo "$URL" | sed -E 's/^\w+:\/\///' | cut -d '/' -f 1 | tr -d '.') || true
            FILENAME="${TARGET_DIR}/v6_source_${HOSTNAME}.txt"

            echo "--- Processing URL: $URL ---"
            
            if [ -z "$HOSTNAME" ]; then
                echo "âŒ Failed to extract hostname from $URL. Skipping."
                continue
            fi
            
            # ä½¿ç”¨ curl è·å–å†…å®¹
            if curl -s -L "$URL" > "$FILENAME"; then
              
              # ç¡®ä¿æ–‡ä»¶æœ«å°¾æœ‰æ¢è¡Œç¬¦
              echo "" >> "$FILENAME" 
              
              LINES=$(wc -l < "$FILENAME") || true
              if [ "$LINES" -gt 0 ]; then
                  echo "âœ… Successfully fetched $LINES lines, saved as $FILENAME"
                  # å°†ç»“æœè¿½åŠ åˆ°æ–‡ä»¶
                  echo "- Fetched ${LINES} lines from ${HOSTNAME}" >> "$COMMIT_DETAILS_BODY_FILE"
                  COUNT=$((COUNT + 1))
              else
                  echo "âš ï¸ Fetched content is empty from $URL. Skipping file creation."
                  rm -f "$FILENAME"
              fi
            else
              echo "âŒ Failed to fetch content from $URL (Curl returned error). Skipping this URL."
              rm -f "$FILENAME"
            fi
            
          done
          
          echo "Finished fetching. Total files created: $COUNT"
          
          # 1. ä¼ é€’ files_created (å•è¡Œæ ¼å¼)
          echo "files_created=$COUNT" >> $GITHUB_OUTPUT
          
          # 2. *** å…³é”®ä¿®å¤ 2/2ï¼šå°† HEADER å’Œ BODY åˆå¹¶åˆ°æœ€ç»ˆçš„æäº¤ä¿¡æ¯æ–‡ä»¶ ***
          HEADER_MESSAGE="Auto update IPv6 sources (${COUNT} files)"
          (echo "$HEADER_MESSAGE"; echo ""; cat "$COMMIT_DETAILS_BODY_FILE") > "$COMMIT_MESSAGE_FILE"


      - name: ğŸ’¾ Sync Files to Target Repository
        if: steps.fetch.outputs.files_created > 0
        
        env:
          TARGET_URL: ${{ secrets.TARGET_REPO }}
          TARGET_PAT: ${{ secrets.TARGET_PAT }}
          TARGET_FOLDER: ${{ secrets.TARGET_FOLDER }}
          TEMP_DIR: ./ipv6_fetch_temp
          
        run: |
          echo "Starting synchronization to target repository..."

          if [ -z "$TARGET_URL" ] || [ -z "$TARGET_PAT" ] || [ -z "$TARGET_FOLDER" ]; then
              echo "::error::Target repository secrets (TARGET_REPO, TARGET_PAT, or TARGET_FOLDER) are not configured. Skipping synchronization."
              exit 0 
          fi
          
          # è‡ªåŠ¨è¯†åˆ« TARGET_REPO æ ¼å¼
          TARGET_URL_RAW="${TARGET_URL}"
          TARGET_URL_HOST=""
          
          if [[ $TARGET_URL_RAW == *"."* ]] || [[ $TARGET_URL_RAW == https://* ]]; then
              TARGET_URL_HOST=$(echo "$TARGET_URL_RAW" | sed 's/https:\/\///')
          else
              TARGET_URL_HOST="github.com/${TARGET_URL_RAW}"
          fi
          
          TARGET_URL_WITH_PAT="https://${TARGET_PAT}@${TARGET_URL_HOST}"
          
          # 1. å…‹éš†ç›®æ ‡ä»“åº“
          git clone $TARGET_URL_WITH_PAT target_repo_sync
          
          # 2. ç›®æ ‡ç›®å½•å‡†å¤‡
          cd target_repo_sync
          mkdir -p "${TARGET_FOLDER}"
          
          # 3. å¤åˆ¶æ–‡ä»¶
          git config core.fileMode false
          cp -f ../${TEMP_DIR}/*.txt "./${TARGET_FOLDER}/"
          
          # 4. æ£€æŸ¥æ˜¯å¦æœ‰å˜åŠ¨å¹¶æäº¤
          git add .
          
          if git diff --cached --exit-code; then
            echo "::debug::No changes detected in target repository. Skipping commit/push."
            exit 0
          else
            # *** å…³é”®ä¿®å¤ï¼šä½¿ç”¨ git commit -F <file> ä»æ–‡ä»¶ä¸­è¯»å–æäº¤ä¿¡æ¯ ***
            COMMIT_FILE="../final_commit_message.txt"
            
            if git commit -F "$COMMIT_FILE" --allow-empty-message; then
              echo "Committing changes successfully."
              git push origin main
              echo "âœ… Push successful."
              exit 0
            else
              # --- æ‰“å°é”™è¯¯åŸå›  ---
              echo "--- âŒ GIT COMMIT FAILED ---"
              echo "WARNING: Git commit returned non-zero exit code (é€šå¸¸æ˜¯ 1, åŸå› æ˜¯æ–‡ä»¶è­¦å‘Šæˆ–é…ç½®é—®é¢˜)."
              echo "è¯·æ£€æŸ¥ä¸Šæ–¹æ—¥å¿—ä¸­ 'git commit' é™„è¿‘çš„ WARNING æˆ– ERROR è¾“å‡ºæ¥æŸ¥æ‰¾å…·ä½“åŸå› ã€‚"
              echo "å°è¯•å¼ºåˆ¶æ¨é€æ›´æ”¹ä»¥ç¡®ä¿åŒæ­¥..."
              
              # å°è¯•æ¨é€ã€‚å¦‚æœæ¨é€å¤±è´¥ï¼Œè„šæœ¬ä¼šè¿”å›éé›¶é€€å‡ºç ï¼Œå·¥ä½œæµä¼šæ ‡è®°ä¸ºå¤±è´¥ã€‚
              git push origin main 
            fi
          fi